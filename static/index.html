<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>プログラミングゲーム（仮）</title>
</head>

<body>
  <script type="module">
    import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
    window.onload = async () => {
      // get map
      const stagename = 4;

      // マップタイルの表示
      const mapstr = await fetchJSON("api/stage", { "name": stagename });
      const map = JSON.parse(mapstr)["stage"];
      const start = JSON.parse(mapstr)["start"];
      const goal = JSON.parse(mapstr)["goal"];

      // tile size
      const tilesize = 32;

      // canvas設定
      const canvas = document.getElementById("canvas");
      canvas.width = tilesize * map[0].length; // canvasの横幅
      canvas.height = tilesize * map.length; // canvasの縦幅

      // コンテキスト取得
      const ctx = canvas.getContext('2d');

      // マップタイル用Imageオブジェクトの生成
      const maptileWall = new Image();
      // maptile_wall.src = 'img/map01.png';
      maptileWall.setAttribute('src', './img/map01.png');

      const maptileFloor = new Image();
      // maptile_floor.src = 'img/map02.png';
      maptileFloor.setAttribute('src', './img/map02.png');

      const maptileStart = new Image();
      maptileStart.setAttribute('src', './img/start.png');

      const maptileGoal = new Image();
      maptileGoal.setAttribute('src', './img/goal.png');


      function render() {
        for (let y = 0; y < map.length; y++) {
          for (let x = 0; x < map[y].length; x++) {
            if (map[y][x] === 0) {
              ctx.drawImage(
                maptileWall,
                0, 0,
                maptileWall.naturalWidth, maptileWall.naturalHeight,
                tilesize * x, tilesize * y,
                tilesize, tilesize,
              );
            }
            if (map[y][x] === 1) {
              ctx.drawImage(
                maptileFloor,
                0, 0,
                maptileFloor.naturalWidth, maptileFloor.naturalHeight,
                tilesize * x, tilesize * y,
                tilesize, tilesize,
              );
              if (y === start[0] && x === start[1]) {
                ctx.drawImage(
                  maptileStart,
                  0, 0,
                  maptileStart.naturalWidth, maptileStart.naturalHeight,
                  tilesize * x, tilesize * y,
                  tilesize, tilesize,
                );
              }
              if (y === goal[0] && x === goal[1]) {
                ctx.drawImage(
                  maptileGoal,
                  0, 0,
                  maptileGoal.naturalWidth, maptileGoal.naturalHeight,
                  tilesize * x, tilesize * y,
                  tilesize, tilesize,
                );
              }
            }
          }
        }
        requestAnimationFrame(render);
      }

      requestAnimationFrame(render);
    }
  </script>

  <canvas id="canvas"></canvas>
</body>

</html>